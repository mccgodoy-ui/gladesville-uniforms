<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pre-Loved Uniforms - Gladesville Public School</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <style>
    :root{
      --brand-navy:#0f3d63;
      --brand-teal:#0f8b8d;
      --brand-amber:#f59e0b;
    }
    .pill { padding: .5rem .9rem; border-radius:9999px; font-size:.875rem; font-weight:600; transition:all .15s; }
    .pill-active { background:var(--brand-amber); color:#1f2937; }
    .pill-idle { background:#ffffff; color:#111827; border:1px solid #e5e7eb; }
    .pill-idle:hover { background:#f3f4f6; }
    .chip { border-radius:9999px; padding:.45rem .8rem; border:1px solid #cbd5e1; }
    .chip-teal { border-color:#99d5d6; color:#064e4f; background:#e6faf9; }
    .btn-primary { background:var(--brand-teal); color:#fff; padding:.5rem 1rem; border-radius:.5rem; }
    .btn-danger { background:#dc2626; color:#fff; padding:.5rem 1rem; border-radius:.5rem; }
    .card { background:#fff; border-radius:18px; box-shadow:0 6px 18px rgba(16,24,40,.08); }
    .soft-panel { background:linear-gradient(120deg,#eaf7f6,#f5fbff); border-left:4px solid var(--brand-teal); border-radius:18px; }
    .field { border:1px solid #e5e7eb; border-radius:12px; padding:.65rem .9rem; width:100%; }
    .banner-image { 
      background: linear-gradient(rgba(15, 61, 99, 0.7), rgba(15, 139, 141, 0.7)), 
                  url('https://images.pexels.com/photos/5905709/pexels-photo-5905709.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1') center/cover;
      min-height: 200px;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app">Loading...</div>

  <script>
    // EmailJS Configuration - Replace with your actual values
    var EMAILJS_SERVICE_ID = 'service_z6psqlh';
    var EMAILJS_TEMPLATE_ID = 'template_6t31ggp';
    var EMAILJS_PUBLIC_KEY = 'SqZoo_2xHoSq2VLVb';

    // Initialize EmailJS
    (function() {
      emailjs.init(EMAILJS_PUBLIC_KEY);
    })();

    // State
    var currentView = 'shop';
    var cart = {};
    var customerInfo = {name:'', whatsapp:'', studentClass:'', notes:''};
    var orders = [];
    var isSubmitting = false;
    var showSuccessMessage = false;
    var isAdminLoggedIn = false;
    var adminPassword = 'gps25';
    var editingItemId = null;

    // Inventory
    var inventory = [
      {id:1, name:'Polo Shirt', price:2, category:'Shirts'},
      {id:2, name:'Long Sleeve Polo', price:2, category:'Shirts'},
      {id:3, name:'School Pants', price:2, category:'Bottoms'},
      {id:4, name:'Skort', price:2, category:'Bottoms'},
      {id:5, name:'Summer Dress', price:2, category:'Dresses'},
      {id:6, name:'Winter Tunic', price:2, category:'Dresses'},
      {id:7, name:'Jumper', price:5, category:'Winter'},
      {id:8, name:'School Hat', price:2, category:'Accessories'}
    ];

    var sizes = ['4','6','8','10','12','14','16'];
    var categories = ['All','Shirts','Bottoms','Dresses','Winter','Accessories'];
    var activeCategory = 'All';

    // Helper Functions
    function filteredInventory() {
      if (activeCategory === 'All') return inventory;
      return inventory.filter(function(item) {
        return item.category === activeCategory;
      });
    }

    function addToCart(id, size) {
      var item = inventory.find(function(i) { return i.id === id; });
      if (!item) return;
      var key = id + '-' + size;
      if (cart[key]) {
        cart[key].quantity += 1;
      } else {
        cart[key] = {
          id: item.id,
          name: item.name,
          price: item.price,
          size: size,
          quantity: 1
        };
      }
      render();
    }

    function removeFromCart(key) {
      if (!cart[key]) return;
      if (cart[key].quantity > 1) {
        cart[key].quantity -= 1;
      } else {
        delete cart[key];
      }
      render();
    }

    function getCartTotal() {
      var total = 0;
      for (var key in cart) {
        total += cart[key].price * cart[key].quantity;
      }
      return total;
    }

    function getCartCount() {
      var count = 0;
      for (var key in cart) {
        count += cart[key].quantity;
      }
      return count;
    }

    function setCategory(cat) {
      activeCategory = cat;
      render();
    }

    function updateName(value) { customerInfo.name = value; }
    function updateWhatsApp(value) { customerInfo.whatsapp = value; }
    function updateClass(value) { customerInfo.studentClass = value; }
    function updateNotes(value) { customerInfo.notes = value; }

    // Email notification function using EmailJS
    function sendEmailNotification(order) {
      // Format items list for email
      var itemsList = '';
      for (var key in order.items) {
        var item = order.items[key];
        itemsList += item.quantity + 'x ' + item.name + ' (Size ' + item.size + ') - $' + (item.price * item.quantity) + '\n';
      }

      // Email template parameters
      var templateParams = {
        to_email: 'soulorganiser4u@gmail.com',
        customer_name: order.customer.name,
        customer_whatsapp: order.customer.whatsapp,
        customer_class: order.customer.studentClass,
        customer_notes: order.customer.notes || 'None',
        order_date: order.date,
        order_time: order.time,
        items_list: itemsList,
        order_total: order.total,
        order_id: order.id
      };

      // Send email using EmailJS
      emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams)
        .then(function(response) {
          console.log('Email sent successfully!', response.status, response.text);
        })
        .catch(function(error) {
          console.error('Failed to send email:', error);
          // Fallback to mailto link if EmailJS fails
          var mailtoLink = 'mailto:soulorganiser4u@gmail.com' +
            '?subject=' + encodeURIComponent('New Uniform Pre-Order - ' + order.customer.name) +
            '&body=' + encodeURIComponent(formatOrderForEmail(order));
          window.open(mailtoLink);
        });
    }

    function formatOrderForEmail(order) {
      var emailBody = 'NEW UNIFORM PRE-ORDER\n\n';
      emailBody += 'Customer Details:\n';
      emailBody += 'Name: ' + order.customer.name + '\n';
      emailBody += 'WhatsApp: ' + order.customer.whatsapp + '\n';
      emailBody += 'Class: ' + order.customer.studentClass + '\n';
      emailBody += 'Date: ' + order.date + ' at ' + order.time + '\n';
      if (order.customer.notes) {
        emailBody += 'Notes: ' + order.customer.notes + '\n';
      }
      emailBody += '\nItems Ordered:\n';
      for (var key in order.items) {
        var item = order.items[key];
        emailBody += '• ' + item.quantity + 'x ' + item.name + ' (Size ' + item.size + ') - $' + (item.price * item.quantity) + '\n';
      }
      emailBody += '\nTotal: $' + order.total + '\n\n';
      emailBody += 'Please contact the customer via WhatsApp to arrange photo sharing and payment.';
      return emailBody;
    }

    function submitOrder() {
      if (!customerInfo.name || !customerInfo.whatsapp || !customerInfo.studentClass) {
        alert('Please fill in all required fields');
        return;
      }
      if (Object.keys(cart).length === 0) {
        alert('Please add items to cart');
        return;
      }

      var order = {
        id: Date.now(),
        customer: customerInfo,
        items: cart,
        total: getCartTotal(),
        date: new Date().toLocaleDateString(),
        time: new Date().toLocaleTimeString()
      };

      orders.push(order);
      
      // Send email notification
      sendEmailNotification(order);
      
      cart = {};
      customerInfo = {name:'', whatsapp:'', studentClass:'', notes:''};
      showSuccessMessage = true;
      render();

      setTimeout(function() {
        showSuccessMessage = false;
        render();
      }, 3000);
    }

    function login() {
      var password = prompt('Enter admin password:');
      if (password === adminPassword) {
        isAdminLoggedIn = true;
        currentView = 'admin';
        render();
      } else if (password) {
        alert('Incorrect password');
      }
    }

    function logout() {
      isAdminLoggedIn = false;
      currentView = 'shop';
      render();
    }

    function goToShop() {
      currentView = 'shop';
      render();
    }

    function deleteOrder(orderId) {
      orders = orders.filter(function(o) { return o.id !== orderId; });
      render();
    }

    function copyOrder(order) {
      var text = 'NEW ORDER\n';
      text += 'Customer: ' + order.customer.name + '\n';
      text += 'WhatsApp: ' + order.customer.whatsapp + '\n';
      text += 'Class: ' + order.customer.studentClass + '\n';
      text += 'Date: ' + order.date + ' ' + order.time + '\n';
      if (order.customer.notes) text += 'Notes: ' + order.customer.notes + '\n';
      text += '\nITEMS:\n';
      for (var key in order.items) {
        var item = order.items[key];
        text += item.quantity + 'x ' + item.name + ' (Size ' + item.size + ')\n';
      }
      text += '\nTOTAL: $' + order.total;

      if (navigator.clipboard) {
        navigator.clipboard.writeText(text);
        alert('Order copied to clipboard!');
      } else {
        alert('Copy not supported in this browser');
      }
    }

    // Admin Functions
    function startEdit(id) {
      editingItemId = id;
      render();
    }

    function cancelEdit() {
      editingItemId = null;
      render();
    }

    function saveEdit(id) {
      var nameEl = document.getElementById('edit_name_' + id);
      var priceEl = document.getElementById('edit_price_' + id);
      if (!nameEl || !priceEl) return;

      var name = nameEl.value.trim();
      var price = parseFloat(priceEl.value);
      if (!name || isNaN(price)) {
        alert('Please enter valid name and price');
        return;
      }

      var item = inventory.find(function(i) { return i.id === id; });
      if (item) {
        item.name = name;
        item.price = price;
        editingItemId = null;
        render();
      }
    }

    function removeItem(id) {
      inventory = inventory.filter(function(i) { return i.id !== id; });
      render();
    }

    function addItem() {
      var name = document.getElementById('new_name').value.trim();
      var price = parseFloat(document.getElementById('new_price').value);
      var category = document.getElementById('new_category').value;

      if (!name || isNaN(price) || !category) {
        alert('Please fill in all fields');
        return;
      }

      var maxId = Math.max.apply(Math, inventory.map(function(i) { return i.id; }));
      inventory.push({
        id: maxId + 1,
        name: name,
        price: price,
        category: category
      });

      document.getElementById('new_name').value = '';
      document.getElementById('new_price').value = '';
      render();
    }

    // Render Functions
    function renderHeader() {
      var cartCount = getCartCount();
      var orderCount = orders.length;

      return '<div class="banner-image text-white">' +
        '<div class="bg-blue-900 bg-opacity-90 p-4">' +
        '<div class="max-w-6xl mx-auto flex justify-between items-center">' +
          '<div>' +
            '<h1 class="text-2xl font-bold flex items-center gap-2">' +
              '<svg class="w-8 h-8 text-green-400" fill="currentColor" viewBox="0 0 24 24">' +
                '<path d="M12 2L13.09 8.26L22 9L13.09 9.74L12 16L10.91 9.74L2 9L10.91 8.26L12 2M12 2L13.09 8.26L22 9L13.09 9.74L12 16L10.91 9.74L2 9L10.91 8.26L12 2Z"/>' +
                '<path d="M17.66 8L18.5 10.5L21 11.34L18.5 12.16L17.66 14.66L16.84 12.16L14.34 11.34L16.84 10.5L17.66 8M6.34 8L7.16 10.5L9.66 11.34L7.16 12.16L6.34 14.66L5.5 12.16L3 11.34L5.5 10.5L6.34 8Z"/>' +
              '</svg>' +
              'Pre-Loved Uniforms' +
            '</h1>' +
            '<p class="text-blue-200">Gladesville Public School</p>' +
          '</div>' +
          '<div class="flex gap-4 items-center">' +
            '<button onclick="login()" class="relative">' +
              '<span class="text-xl">⚙️</span>' +
              (orderCount > 0 ? '<span class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs">' + orderCount + '</span>' : '') +
            '</button>' +
            '<div class="relative">' +
              '<span class="text-xl">🛒</span>' +
              (cartCount > 0 ? '<span class="absolute -top-1 -right-1 bg-yellow-400 text-black rounded-full w-5 h-5 text-xs">' + cartCount + '</span>' : '') +
            '</div>' +
          '</div>' +
        '</div>' +
        '</div>' +
      '</div>';
    }

    function renderInfo() {
      return '<div class="soft-panel p-6 mb-6">' +
        '<h3 class="font-bold text-lg mb-3">How it works:</h3>' +
        '<ul class="space-y-1">' +
          '<li>• Select items and sizes</li>' +
          '<li>• Submit your pre-order</li>' +
          '<li>• We will send photos via WhatsApp</li>' +
          '<li>• Pay through Qkr! when ready</li>' +
          '<li>• Pickup at school</li>' +
        '</ul>' +
      '</div>';
    }

    function renderFilters() {
      var buttons = categories.map(function(cat) {
        var isActive = cat === activeCategory;
        var className = isActive ? 'pill pill-active' : 'pill pill-idle';
        return '<button onclick="setCategory(\'' + cat + '\')" class="' + className + '">' + cat + '</button>';
      });

      return '<div class="flex gap-2 flex-wrap justify-center mb-6">' + buttons.join('') + '</div>';
    }

    function renderProducts() {
      var items = filteredInventory();
      if (items.length === 0) return '<p class="text-gray-500">No items found.</p>';

      var cards = items.map(function(item) {
        var sizeButtons = sizes.map(function(size) {
          return '<button onclick="addToCart(' + item.id + ', \'' + size + '\')" class="chip chip-teal">' + size + '</button>';
        });

        return '<div class="card p-4">' +
          '<div class="flex justify-between items-start mb-3">' +
            '<div>' +
              '<h3 class="font-semibold">' + item.name + '</h3>' +
              '<span class="text-xs bg-gray-100 px-2 py-1 rounded">' + item.category + '</span>' +
            '</div>' +
            '<span class="text-lg font-bold text-blue-600">$' + item.price + '</span>' +
          '</div>' +
          '<div class="mb-2">Select Size:</div>' +
          '<div class="flex gap-2 flex-wrap">' + sizeButtons.join('') + '</div>' +
        '</div>';
      });

      return '<div class="grid md:grid-cols-2 gap-4">' + cards.join('') + '</div>';
    }

    function renderCart() {
      var cartKeys = Object.keys(cart);
      var total = getCartTotal();
      var canSubmit = customerInfo.name && customerInfo.whatsapp && customerInfo.studentClass && cartKeys.length > 0;

      var cartItems = cartKeys.length === 0 ? 
        '<div class="text-center py-8 text-gray-500">No items in cart</div>' :
        cartKeys.map(function(key) {
          var item = cart[key];
          return '<div class="flex justify-between items-center p-2 bg-gray-50 rounded">' +
            '<div>' +
              '<div class="font-medium">' + item.name + '</div>' +
              '<div class="text-sm text-gray-500">Size ' + item.size + '</div>' +
            '</div>' +
            '<div class="flex items-center gap-2">' +
              '<button onclick="removeFromCart(\'' + key + '\')" class="text-red-500">-</button>' +
              '<span>' + item.quantity + '</span>' +
              '<button onclick="addToCart(' + item.id + ', \'' + item.size + '\')" class="text-green-500">+</button>' +
            '</div>' +
          '</div>';
        }).join('');

      var successMsg = showSuccessMessage ? 
        '<div class="bg-green-50 border border-green-200 text-green-800 p-3 rounded mb-4">' +
          '<div class="font-semibold">Order Submitted!</div>' +
          '<div class="text-sm">We will contact you via WhatsApp</div>' +
        '</div>' : '';

      return '<div class="card p-4 sticky top-4">' +
        '<h2 class="text-xl font-semibold mb-4 bg-teal-600 text-white p-3 -m-4 rounded-t-lg">Your Order</h2>' +
        '<div class="mt-4 space-y-3 mb-4">' +
          '<input type="text" placeholder="Your name *" value="' + customerInfo.name + '" onchange="updateName(this.value)" class="field">' +
          '<input type="text" placeholder="WhatsApp number *" value="' + customerInfo.whatsapp + '" onchange="updateWhatsApp(this.value)" class="field">' +
          '<input type="text" placeholder="Student class *" value="' + customerInfo.studentClass + '" onchange="updateClass(this.value)" class="field">' +
          '<textarea placeholder="Notes (optional)" rows="2" onchange="updateNotes(this.value)" class="field">' + customerInfo.notes + '</textarea>' +
        '</div>' +
        '<div class="space-y-2 mb-4">' + cartItems + '</div>' +
        (cartKeys.length > 0 ? 
          '<div class="border-t pt-3 mb-4">' +
            '<div class="flex justify-between items-center">' +
              '<span class="font-semibold">Total:</span>' +
              '<span class="text-xl font-bold text-blue-600">$' + total + '</span>' +
            '</div>' +
          '</div>' : ''
        ) +
        successMsg +
        '<button onclick="submitOrder()" ' + (canSubmit ? '' : 'disabled') + ' class="' + 
        (canSubmit ? 'btn-primary' : 'bg-gray-300 text-gray-500') + ' w-full">Submit Order</button>' +
      '</div>';
    }

    function renderShop() {
      return renderHeader() +
        '<div class="max-w-6xl mx-auto p-4">' +
          '<div class="grid lg:grid-cols-3 gap-6">' +
            '<div class="lg:col-span-2 space-y-6">' +
              renderInfo() +
              renderFilters() +
              renderProducts() +
            '</div>' +
            '<div>' +
              renderCart() +
            '</div>' +
          '</div>' +
        '</div>';
    }

    function renderAdmin() {
      if (!isAdminLoggedIn) {
        return '<div class="min-h-screen flex items-center justify-center">' +
          '<div class="card p-8 text-center">' +
            '<h2 class="text-xl font-bold mb-4">Admin Access</h2>' +
            '<button onclick="login()" class="btn-primary mr-3">Login</button>' +
            '<button onclick="goToShop()" class="bg-gray-500 text-white px-4 py-2 rounded">Back</button>' +
          '</div>' +
        '</div>';
      }

      var inventoryList = inventory.map(function(item) {
        if (editingItemId === item.id) {
          return '<div class="flex items-center gap-3 p-3 bg-blue-50 border-2 border-blue-200 rounded">' +
            '<input id="edit_name_' + item.id + '" value="' + item.name + '" class="field flex-1">' +
            '<input id="edit_price_' + item.id + '" value="' + item.price + '" type="number" class="field w-20">' +
            '<span class="text-xs bg-gray-100 px-2 py-1 rounded">' + item.category + '</span>' +
            '<button onclick="saveEdit(' + item.id + ')" class="bg-green-500 text-white px-3 py-1 rounded">Save</button>' +
            '<button onclick="cancelEdit()" class="bg-gray-400 text-white px-3 py-1 rounded">Cancel</button>' +
          '</div>';
        } else {
          return '<div class="flex items-center justify-between p-3 bg-gray-50 rounded">' +
            '<div class="flex items-center gap-3">' +
              '<span class="font-medium">' + item.name + '</span>' +
              '<span class="text-xs bg-gray-100 px-2 py-1 rounded">' + item.category + '</span>' +
            '</div>' +
            '<div class="flex items-center gap-3">' +
              '<span class="font-bold text-blue-600">$' + item.price + '</span>' +
              '<button onclick="startEdit(' + item.id + ')" class="bg-blue-500 text-white px-2 py-1 rounded text-sm">Edit</button>' +
              '<button onclick="removeItem(' + item.id + ')" class="bg-red-500 text-white px-2 py-1 rounded text-sm">Remove</button>' +
            '</div>' +
          '</div>';
        }
      }).join('');

      var ordersList = orders.map(function(order) {
        var itemsList = Object.keys(order.items).map(function(key) {
          var item = order.items[key];
          return '<div class="text-sm">' + item.quantity + 'x ' + item.name + ' (Size ' + item.size + ')</div>';
        }).join('');

        return '<div class="border rounded p-4 bg-white">' +
          '<div class="flex justify-between items-start mb-3">' +
            '<div>' +
              '<h3 class="font-bold">' + order.customer.name + '</h3>' +
              '<div class="text-sm text-gray-600">WhatsApp: ' + order.customer.whatsapp + '</div>' +
              '<div class="text-sm text-gray-600">Class: ' + order.customer.studentClass + '</div>' +
              '<div class="text-sm text-gray-600">' + order.date + ' ' + order.time + '</div>' +
            '</div>' +
            '<div class="text-right">' +
              '<div class="text-lg font-bold text-blue-600">$' + order.total + '</div>' +
              '<div class="flex gap-2 mt-2">' +
                '<button onclick="copyOrder(orders.find(function(o) { return o.id === ' + order.id + '; }))" class="bg-blue-500 text-white px-2 py-1 rounded text-xs">Copy</button>' +
                '<button onclick="deleteOrder(' + order.id + ')" class="bg-red-500 text-white px-2 py-1 rounded text-xs">Delete</button>' +
              '</div>' +
            '</div>' +
          '</div>' +
          '<div class="space-y-1">' + itemsList + '</div>' +
        '</div>';
      }).join('');

      return renderHeader() +
        '<div class="max-w-6xl mx-auto p-4 space-y-6">' +
          '<div class="card p-4 flex justify-between items-center">' +
            '<h1 class="text-2xl font-bold">Admin Panel</h1>' +
            '<div class="space-x-2">' +
              '<button onclick="logout()" class="btn-danger">Logout</button>' +
              '<button onclick="goToShop()" class="btn-primary">Shop</button>' +
            '</div>' +
          '</div>' +
          '<div class="card p-4">' +
            '<h2 class="text-xl font-semibold mb-4">Inventory (' + inventory.length + ')</h2>' +
            '<div class="space-y-2 mb-4">' + inventoryList + '</div>' +
            '<div class="grid md:grid-cols-4 gap-3 p-3 bg-gray-50 rounded">' +
              '<input id="new_name" placeholder="Item name" class="field">' +
              '<input id="new_price" placeholder="Price" type="number" class="field">' +
              '<select id="new_category" class="field">' +
                '<option value="Shirts">Shirts</option>' +
                '<option value="Bottoms">Bottoms</option>' +
                '<option value="Dresses">Dresses</option>' +
                '<option value="Winter">Winter</option>' +
                '<option value="Accessories">Accessories</option>' +
              '</select>' +
              '<button onclick="addItem()" class="btn-primary">Add Item</button>' +
            '</div>' +
          '</div>' +
          '<div class="card p-4">' +
            '<h2 class="text-xl font-semibold mb-4">Orders (' + orders.length + ')</h2>' +
            '<div class="space-y-4">' + (ordersList || '<p class="text-gray-500">No orders yet</p>') + '</div>' +
          '</div>' +
        '</div>';
    }

    function render() {
      var app = document.getElementById('app');
      if (currentView === 'admin') {
        app.innerHTML = renderAdmin();
      } else {
        app.innerHTML = renderShop();
      }
    }

    // Initialize
    render();
  </script>
</body>
</html>
